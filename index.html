<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Math Practice">
    <meta name="format-detection" content="telephone=no">
    <title>1st Grade Math Practice - California Standards</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: linear-gradient(135deg, #cce7ff 0%, #d4f0f0 100%);
            min-height: 100vh;
            padding: 20px;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            overscroll-behavior: none;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: #FFFFFF;
            border-radius: 30px;
            padding: 40px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.15);
        }
        
        h1 {
            text-align: center;
            color: #1a1a1a;
            margin-bottom: 10px;
            font-size: 2.8em;
            font-weight: 800;
            letter-spacing: -1px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            font-size: 1.1em;
            margin-bottom: 30px;
            font-weight: 500;
        }
        
        .start-screen {
            text-align: center;
            padding: 60px 40px;
            position: relative;
        }
        
        .start-screen::before {
            content: 'üìö';
            font-size: 5em;
            display: block;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        
        .start-screen h2 {
            font-size: 2.2em;
            font-weight: 800;
            color: #1a1a1a;
            margin-bottom: 20px;
            letter-spacing: -0.5px;
        }
        
        .start-screen p {
            font-size: 1.1em;
            color: #666;
            line-height: 1.8;
            margin-bottom: 40px;
        }
        
        .timer-container {
            background: #ffffff;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            margin: 30px auto;
            max-width: 400px;
        }
        
        .timer-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .timer-label {
            font-size: 1.1em;
            font-weight: 600;
            color: #1a1a1a;
        }
        
        .timer-toggle {
            position: relative;
            width: 60px;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .timer-toggle.active {
            background: linear-gradient(135deg, #a3d5ff 0%, #b8e6f0 100%);
        }
        
        .timer-toggle-slider {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .timer-toggle.active .timer-toggle-slider {
            transform: translateX(30px);
        }
        
        .timer-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .timer-input {
            width: 80px;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            font-size: 1.1em;
            font-weight: 600;
        }
        
        /* Hide number input arrows for timer */
        .timer-input::-webkit-outer-spin-button,
        .timer-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .timer-input[type=number] {
            -moz-appearance: textfield;
        }
        
        .timer-input:focus {
            outline: none;
            border-color: #a3d5ff;
        }
        
        .timer-input:disabled {
            background: #f5f5f5;
            color: #999;
        }
        
        .question-selector {
            background: #ffffff;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            margin: 20px auto 30px auto;
            max-width: 400px;
        }
        
        .question-selector-label {
            font-size: 1.1em;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .question-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .question-btn {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            color: #666;
        }
        
        .question-btn:hover {
            border-color: #a3d5ff;
            transform: translateY(-2px);
        }
        
        .question-btn.selected {
            background: linear-gradient(135deg, #a3d5ff 0%, #b8e6f0 100%);
            border-color: #a3d5ff;
            color: white;
        }
        
        .timer-display {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            font-size: 1.3em;
            font-weight: 700;
            color: #1a1a1a;
            z-index: 1000;
            display: none;
        }
        
        .timer-display.active {
            display: block;
        }
        
        .timer-display.warning {
            background: linear-gradient(135deg, #ffe5a3 0%, #fff0c9 100%);
            animation: pulse 1s infinite;
        }
        
        .timer-display.critical {
            background: linear-gradient(135deg, #ffb3d9 0%, #ffc9e5 100%);
            animation: pulse 0.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .timer-progress-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: #e0e0e0;
            z-index: 999;
            display: none;
        }
        
        .timer-progress-container.active {
            display: block;
        }
        
        .timer-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #a3d5ff 0%, #b8e6f0 100%);
            transition: width 1s linear;
        }
        
        .timer-progress-bar.warning {
            background: linear-gradient(90deg, #ffe5a3 0%, #fff0c9 100%);
        }
        
        .timer-progress-bar.critical {
            background: linear-gradient(90deg, #ffb3d9 0%, #ffc9e5 100%);
        }
        
        .start-button {
            background: linear-gradient(135deg, #a3d5ff 0%, #b8e6f0 100%);
            color: white;
            border: none;
            padding: 20px 60px;
            font-size: 1.3em;
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(163, 213, 255, 0.3);
            -webkit-appearance: none;
            -webkit-tap-highlight-color: transparent;
            min-height: 44px;
            min-width: 44px;
        }
        
        .start-button:hover, .start-button:active {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(163, 213, 255, 0.4);
        }
        
        .quiz-container {
            display: none;
        }
        
        .progress-bar {
            background: #f0f0f0;
            height: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #a3d5ff 0%, #b8e6f0 100%);
            height: 100%;
            width: 0%;
            min-width: 100px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            white-space: nowrap;
            font-size: 0.95em;
        }
        
        .question-card {
            background: #fafafa;
            border: none;
            border-radius: 20px;
            padding: 35px;
            margin-bottom: 25px;
            min-height: 250px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        
        .question-content-wrapper {
            display: flex;
            gap: 25px;
        }
        
        .question-main {
            flex: 1;
            min-width: 0;
            width: 50%;
            overflow-x: auto;
        }
        
        .workspace {
            background: #ffffff;
            border: 2px solid #f0f0f0;
            border-radius: 20px;
            padding: 20px;
            width: 50%;
            display: flex;
            flex-direction: column;
            min-height: 700px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        
        .workspace-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .workspace-title {
            color: #666;
            font-size: 0.95em;
            font-weight: 600;
            text-align: center;
            letter-spacing: 0.5px;
        }
        
        .workspace-title::before {
            content: 'üé® ';
            font-size: 1.3em;
        }
        
        .workspace-fullwidth {
            width: 100%;
            margin: 20px 0;
        }
        
        .question-number {
            color: #a3d5ff;
            font-size: 0.9em;
            margin-bottom: 15px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .question-text {
            font-size: 1.4em;
            color: #1a1a1a;
            margin-bottom: 25px;
            line-height: 1.6;
            font-weight: 600;
        }
        
        .answer-input {
            font-size: 1.3em;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            width: 200px;
            text-align: center;
            -webkit-appearance: none;
            appearance: none;
            margin-top: 20px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        /* Hide number input arrows */
        .answer-input::-webkit-outer-spin-button,
        .answer-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .answer-input[type=number] {
            -moz-appearance: textfield;
        }
        
        .answer-input:focus {
            outline: none;
            border-color: #a3d5ff;
            box-shadow: 0 0 0 4px rgba(163, 213, 255, 0.1);
        }
        
        .submit-button {
            background: #5a67d8;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s;
            -webkit-appearance: none;
            -webkit-tap-highlight-color: transparent;
            min-height: 44px;
        }
        
        .submit-button:hover, .submit-button:active {
            background: #4c51bf;
        }
        
        .submit-button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }
        
        .number-line {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 30px 0;
            position: relative;
            padding: 20px;
            background: linear-gradient(135deg, rgba(163, 213, 255, 0.05) 0%, rgba(184, 230, 240, 0.05) 100%);
            border-radius: 15px;
        }
        
        .number-line-item {
            position: relative;
            width: 50px;
            text-align: center;
        }
        
        .number-line-tick {
            width: 2px;
            height: 20px;
            background: #4a5568;
            margin: 0 auto;
        }
        
        .number-line-number {
            margin-top: 10px;
            font-size: 1.1em;
            color: #a3d5ff;
            font-weight: 700;
        }
        
        .number-line-line {
            position: absolute;
            top: 10px;
            left: 0;
            right: 0;
            height: 2px;
            background: #4a5568;
            z-index: -1;
        }
        
        .make-ten-boxes {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
            flex-wrap: wrap;
        }
        
        .ten-frame-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 230px;
        }
        
        .ten-frame {
            border: 2px solid #4a5568;
            display: inline-grid;
            grid-template-columns: repeat(5, 40px);
            grid-template-rows: repeat(2, 40px);
            gap: 2px;
            background: white;
            padding: 5px;
            box-sizing: content-box;
        }
        
        .ten-frame-dot {
            border: 1px solid #cbd5e0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: white;
            transition: background 0.2s;
        }
        
        .ten-frame-dot:hover {
            background: #f7fafc;
        }
        
        .ten-frame-dot.filled .dot {
            animation: popIn 0.2s ease-out;
        }
        
        @keyframes popIn {
            0% {
                transform: scale(0);
            }
            80% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
            }
        }
        
        .workspace {
            background: #fef9e7;
            border: 2px dashed #f4d03f;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            min-height: 150px;
        }
        
        .workspace-title {
            color: #7a7a7a;
            font-size: 14px;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .drawing-canvas {
            border: 2px solid #f0f0f0;
            border-radius: 15px;
            cursor: crosshair;
            display: block;
            background: white;
            touch-action: none;
            width: 100%;
            height: 100%;
            -webkit-user-select: none;
            user-select: none;
            flex: 1;
            min-height: 600px;
        }
        
        .canvas-controls {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .canvas-button {
            padding: 10px 18px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            -webkit-appearance: none;
            -webkit-tap-highlight-color: transparent;
            min-height: 40px;
            transition: all 0.2s ease;
        }
        
        .canvas-button:hover, .canvas-button:active {
            background: #f5f5f5;
            transform: scale(1.02);
        }
        
        .canvas-button.active {
            border: 3px solid #a3d5ff;
            box-shadow: 0 0 0 3px rgba(163, 213, 255, 0.15);
            transform: scale(1.05);
            background: #e6f7ff;
        }
        
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
            gap: 15px;
        }
        
        .nav-button {
            padding: 15px 30px;
            background: #ffffff;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            -webkit-appearance: none;
            -webkit-tap-highlight-color: transparent;
            min-height: 44px;
            flex: 1;
        }
        
        .nav-button:hover:not(:disabled), .nav-button:active:not(:disabled) {
            background: #f5f5f5;
            transform: translateY(-1px);
        }
        
        .nav-button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .nav-button#nextButton {
            background: linear-gradient(135deg, #a3d5ff 0%, #b8e6f0 100%);
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(163, 213, 255, 0.3);
        }
        
        .nav-button#nextButton:hover:not(:disabled) {
            background: linear-gradient(135deg, #8ec9ff 0%, #a3dde8 100%);
            box-shadow: 0 6px 20px rgba(163, 213, 255, 0.4);
        }
        
        .make-ten-equations {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
            align-items: center;
        }
        
        .equation-line {
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 24px;
        }
        
        .equation-blank {
            width: 60px;
            height: 40px;
            border: 2px solid #cbd5e0;
            border-radius: 5px;
            text-align: center;
            font-size: 20px;
            -webkit-appearance: none;
            appearance: none;
        }
        
        /* Hide number input arrows for equation blanks */
        .equation-blank::-webkit-outer-spin-button,
        .equation-blank::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .equation-blank[type=number] {
            -moz-appearance: textfield;
        }
        
        .answer-review {
            margin: 30px 0;
            padding: 25px;
            background: #fafafa;
            border: 2px solid #f0f0f0;
            border-radius: 20px;
            text-align: left;
        }
        
        .answer-review h3 {
            font-size: 1.5em;
            font-weight: 800;
            color: #1a1a1a;
        }
        
        .answer-review h3::before {
            content: 'üìù ';
            font-size: 1.2em;
        }
        
        .answer-item {
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            border: 1px solid #f0f0f0;
        }
        
        .answer-item:last-child {
            margin-bottom: 0;
        }
        
        .answer-question {
            font-size: 1.05em;
            color: #1a1a1a;
            margin-bottom: 12px;
            font-weight: 700;
        }
        
        .user-answer {
            font-size: 0.95em;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .correct-answer {
            color: #10b981;
        }
        
        .incorrect-answer {
            color: #ef4444;
        }
        
        .answer-explanation {
            background: #f9fafb;
            padding: 12px 15px;
            border-radius: 10px;
            margin-top: 10px;
            font-size: 0.9em;
            color: #4b5563;
            border-left: 3px solid #a3d5ff;
        }
        
        .dot {
            width: 25px;
            height: 25px;
            background: linear-gradient(135deg, #FFB3BA 0%, #FFCCD5 100%);
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(255, 179, 186, 0.3);
        }
        
        .dot.color-pink {
            background: linear-gradient(135deg, #FFB3BA 0%, #FFCCD5 100%);
            box-shadow: 0 2px 8px rgba(255, 179, 186, 0.3);
        }
        
        .dot.color-blue {
            background: linear-gradient(135deg, #BAE1FF 0%, #D4F0FF 100%);
            box-shadow: 0 2px 8px rgba(186, 225, 255, 0.3);
        }
        
        .dot.color-green {
            background: linear-gradient(135deg, #BAFFC9 0%, #D4FFE0 100%);
            box-shadow: 0 2px 8px rgba(186, 255, 201, 0.3);
        }
        
        .dot.color-peach {
            background: linear-gradient(135deg, #FFD9BA 0%, #FFEBD4 100%);
            box-shadow: 0 2px 8px rgba(255, 217, 186, 0.3);
        }
        
        .dot.color-purple {
            background: linear-gradient(135deg, #E0BAFF 0%, #F0D4FF 100%);
            box-shadow: 0 2px 8px rgba(224, 186, 255, 0.3);
        }
        
        .dot.color-yellow {
            background: linear-gradient(135deg, #FFFFBA 0%, #FFFFD4 100%);
            box-shadow: 0 2px 8px rgba(255, 255, 186, 0.3);
        }
        
        .results-screen {
            display: none;
            text-align: center;
            padding: 50px 40px;
            position: relative;
        }
        
        .results-screen::before {
            content: 'üéâ';
            font-size: 6em;
            display: block;
            margin-bottom: 20px;
            animation: celebrate 0.6s ease-in-out;
        }
        
        @keyframes celebrate {
            0% { transform: scale(0) rotate(0deg); }
            50% { transform: scale(1.2) rotate(10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        
        .results-screen h2 {
            font-size: 2em;
            font-weight: 800;
            color: #1a1a1a;
            margin-bottom: 25px;
        }
        
        .score-display {
            font-size: 1.5em;
            color: #333;
            margin: 25px 0;
            font-weight: 600;
        }
        
        .grade-display {
            font-size: 5em;
            margin: 35px 0;
            font-weight: 800;
        }
        
        .feedback {
            font-size: 1.3em;
            color: #666;
            margin-bottom: 35px;
            font-weight: 500;
        }
        
        .restart-button {
            background: linear-gradient(135deg, #a3d5ff 0%, #b8e6f0 100%);
            color: white;
            border: none;
            padding: 18px 50px;
            font-size: 1.2em;
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(163, 213, 255, 0.3);
            -webkit-appearance: none;
            -webkit-tap-highlight-color: transparent;
            min-height: 44px;
        }
        
        .restart-button:hover, .restart-button:active {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(163, 213, 255, 0.4);
        }
        
        .choice-button {
            display: block;
            width: 100%;
            padding: 20px;
            margin: 15px 0;
            background: white;
            border: 3px solid #cbd5e0;
            border-radius: 15px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            -webkit-appearance: none;
            -webkit-tap-highlight-color: transparent;
            min-height: 44px;
        }
        
        .choice-button:hover, .choice-button:active {
            background: #f7fafc;
            transform: translateX(5px);
        }
        
        .choice-button.selected {
            background: #c3dafe;
            border-color: #5a67d8;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }
            
            .question-content-wrapper {
                flex-direction: column;
            }
            
            .question-main, .workspace {
                width: 100%;
                max-width: 100%;
            }
            
            .question-text {
                font-size: 18px;
            }
            
            .answer-input {
                width: 100%;
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .equation-blank {
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .drawing-canvas {
                min-height: 350px;
            }
        }
    </style>
</head>
<body>
    <!-- Timer display (shown during quiz) -->
    <div class="timer-display" id="timerDisplay"></div>
    
    <!-- Timer progress bar -->
    <div class="timer-progress-container" id="timerProgressContainer">
        <div class="timer-progress-bar" id="timerProgress"></div>
    </div>
    
    <div class="container">
        <h1>Math Practice</h1>
        
        <div class="start-screen" id="startScreen">
            <h2>Let's Practice Math!</h2>
            <p>
                Choose how many questions and earn your score.<br>
                Use the drawing area to show your amazing work! ‚ú®
            </p>
            
            <div class="question-selector">
                <div class="question-selector-label">üìù Number of Questions</div>
                <div class="question-buttons">
                    <button class="question-btn" onclick="selectQuestionCount(10)">10</button>
                    <button class="question-btn" onclick="selectQuestionCount(15)">15</button>
                    <button class="question-btn selected" onclick="selectQuestionCount(20)">20</button>
                </div>
            </div>
            
            <div class="timer-container">
                <div class="timer-header">
                    <span class="timer-label">‚è±Ô∏è Enable Timer</span>
                    <div class="timer-toggle" id="timerToggle" onclick="toggleTimer()">
                        <div class="timer-toggle-slider"></div>
                    </div>
                </div>
                <div class="timer-input-group">
                    <input type="number" id="timerMinutes" class="timer-input" value="10" min="0" max="60" placeholder="0" disabled>
                    <span style="font-weight: 600;">minutes</span>
                    <input type="number" id="timerSeconds" class="timer-input" value="0" min="0" max="59" placeholder="0" disabled>
                    <span style="font-weight: 600;">seconds</span>
                </div>
            </div>
            
            <button class="start-button" onclick="startQuiz()">Start Practice</button>
        </div>
        
        <div class="quiz-container" id="quizContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar">
                    <span id="progressText">1 of 20</span>
                </div>
            </div>
            
            <div class="question-card">
                <div class="question-number" id="questionNumber">Question 1</div>
                <div class="question-text" id="questionText"></div>
                <div id="answerArea"></div>
            </div>
            
            <div class="navigation-buttons">
                <button class="nav-button" id="prevButton" onclick="goToPrevious()">‚Üê Previous</button>
                <button class="nav-button" id="nextButton" onclick="goToNext()">Next ‚Üí</button>
            </div>
        </div>
        
        <div class="results-screen" id="resultsScreen">
            <h2 id="resultsTitle"></h2>
            <div class="score-display" id="scoreDisplay"></div>
            <div class="grade-display" id="gradeDisplay"></div>
            <div class="feedback" id="feedback"></div>
        </div>
    </div>

    <script>
        let currentQuestion = 0;
        let score = 0;
        let questions = [];
        let userAnswers = [];
        let canvasData = []; // Store canvas drawings for each question
        let questionCount = 20; // Default to 20 questions
        
        // Timer variables
        let timerEnabled = false;
        let timerMinutes = 10;
        let timerSeconds = 0;
        let totalTimerSeconds = 0;
        let timerInterval = null;
        let remainingSeconds = 0;

        // Initialize ten frame functions globally
        window.toggleDot = function(element, frame, index) {
            const dot = element.querySelector('.dot');
            
            if (!element.classList.contains('filled')) {
                // First click: add pink dot
                element.innerHTML = '<div class="dot color-pink"></div>';
                element.classList.add('filled');
            } else if (dot && dot.classList.contains('color-pink')) {
                // Second click: change to blue
                dot.classList.remove('color-pink');
                dot.classList.add('color-blue');
            } else {
                // Third click: remove dot
                element.innerHTML = '';
                element.classList.remove('filled');
            }
        };
        
        window.clearFrames = function() {
            document.querySelectorAll('.ten-frame-dot').forEach(dot => {
                dot.innerHTML = '';
                dot.classList.remove('filled');
            });
        };
        
        // Timer functions
        function toggleTimer() {
            timerEnabled = !timerEnabled;
            const toggle = document.getElementById('timerToggle');
            const minutesInput = document.getElementById('timerMinutes');
            const secondsInput = document.getElementById('timerSeconds');
            
            if (timerEnabled) {
                toggle.classList.add('active');
                minutesInput.disabled = false;
                secondsInput.disabled = false;
            } else {
                toggle.classList.remove('active');
                minutesInput.disabled = true;
                secondsInput.disabled = true;
            }
        }
        
        function selectQuestionCount(count) {
            questionCount = count;
            // Update button styles
            document.querySelectorAll('.question-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');
        }
        
        function startTimer() {
            if (!timerEnabled) return;
            
            timerMinutes = parseInt(document.getElementById('timerMinutes').value);
            timerSeconds = parseInt(document.getElementById('timerSeconds').value);
            
            // Check if both are empty or 0
            if (isNaN(timerMinutes)) timerMinutes = 0;
            if (isNaN(timerSeconds)) timerSeconds = 0;
            
            totalTimerSeconds = (timerMinutes * 60) + timerSeconds;
            
            // If no time set, default to 10 minutes
            if (totalTimerSeconds === 0) {
                totalTimerSeconds = 600; // 10 minutes
            }
            
            remainingSeconds = totalTimerSeconds;
            
            document.getElementById('timerDisplay').classList.add('active');
            updateTimerDisplay();
            
            timerInterval = setInterval(() => {
                remainingSeconds--;
                updateTimerDisplay();
                
                if (remainingSeconds <= 60) {
                    document.getElementById('timerDisplay').classList.add('warning');
                }
                
                if (remainingSeconds <= 0) {
                    clearInterval(timerInterval);
                    alert('Time is up! The quiz will now be submitted.');
                    showResults();
                }
            }, 1000);
        }
        
        function updateTimerDisplay() {
            const minutes = Math.floor(remainingSeconds / 60);
            const seconds = remainingSeconds % 60;
            const display = document.getElementById('timerDisplay');
            display.textContent = `‚è±Ô∏è ${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            // Update progress bar if visible
            const progressBar = document.getElementById('timerProgress');
            if (progressBar && totalTimerSeconds > 0) {
                const percentage = (remainingSeconds / totalTimerSeconds) * 100;
                progressBar.style.width = percentage + '%';
                
                // Add visual warning as time runs out
                if (remainingSeconds <= 30) {
                    progressBar.classList.add('critical');
                    progressBar.classList.remove('warning');
                } else if (remainingSeconds <= 60) {
                    progressBar.classList.add('warning');
                    progressBar.classList.remove('critical');
                } else {
                    progressBar.classList.remove('warning', 'critical');
                }
            }
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            document.getElementById('timerDisplay').classList.remove('active', 'warning');
        }

        // iOS keyboard handling - scroll input into view
        function setupIOSKeyboardHandling() {
            const inputs = document.querySelectorAll('input[type="number"], textarea');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    setTimeout(() => {
                        this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                });
            });
        }

        // Generate random number within range
        function random(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // Shuffle array
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Generate addition problem (sum up to 20)
        function generateAddition() {
            const a = random(0, 10);
            const b = random(0, 10);
            return {
                type: 'basic',
                question: `${a} + ${b} = ?`,
                answer: a + b,
                inputType: 'number'
            };
        }

        // Generate subtraction problem (within 20)
        function generateSubtraction() {
            const a = random(10, 20);
            const b = random(0, a);
            return {
                type: 'basic',
                question: `${a} - ${b} = ?`,
                answer: a - b,
                inputType: 'number'
            };
        }

        // Generate word problem
        function generateWordProblem() {
            const problems = [
                // Unknown starting value problems
                () => {
                    const gave = random(3, 7);
                    const left = random(8, 15);
                    return {
                        question: `Emily had some apples. She gave ${gave} apples to David. Now Emily has ${left} apples. How many apples did Emily have at first?`,
                        answer: gave + left
                    };
                },
                () => {
                    const found = random(4, 8);
                    const total = random(12, 18);
                    return {
                        question: `Jack had some marbles. He found ${found} more marbles. Now he has ${total} marbles. How many marbles did Jack have before?`,
                        answer: total - found
                    };
                },
                () => {
                    const ate = random(3, 6);
                    const left = random(7, 14);
                    return {
                        question: `Mom had some cookies. The family ate ${ate} cookies. There are ${left} cookies left. How many cookies did Mom have at first?`,
                        answer: ate + left
                    };
                },
                () => {
                    const bought = random(5, 9);
                    const total = random(11, 17);
                    return {
                        question: `Sarah had some toy cars. She bought ${bought} more toy cars. Now she has ${total} toy cars. How many toy cars did she start with?`,
                        answer: total - bought
                    };
                },
                // Comparison and difference problems
                () => {
                    const tom = random(4, 9);
                    const more = random(2, 5);
                    return {
                        question: `Tom has ${tom} books. Lisa has ${more} more books than Tom. How many books does Lisa have?`,
                        answer: tom + more
                    };
                },
                () => {
                    const anna = random(10, 15);
                    const fewer = random(3, 6);
                    return {
                        question: `Anna has ${anna} crayons. Ben has ${fewer} fewer crayons than Anna. How many crayons does Ben have?`,
                        answer: anna - fewer
                    };
                },
                // Multi-step problems
                () => {
                    const morning = random(3, 6);
                    const afternoon = random(4, 7);
                    const gave = random(2, 4);
                    const total = morning + afternoon - gave;
                    return {
                        question: `Lily picked ${morning} flowers in the morning and ${afternoon} flowers in the afternoon. She gave ${gave} flowers to her mom. How many flowers does Lily have now?`,
                        answer: total
                    };
                },
                () => {
                    const had = random(8, 12);
                    const bought = random(3, 6);
                    const lost = random(2, 4);
                    return {
                        question: `Alex had ${had} pencils. He bought ${bought} more pencils, then lost ${lost} pencils. How many pencils does Alex have now?`,
                        answer: had + bought - lost
                    };
                },
                // Missing part problems
                () => {
                    const total = random(12, 18);
                    const red = random(4, 8);
                    return {
                        question: `There are ${total} birds in total. ${red} birds are red. The rest are blue. How many birds are blue?`,
                        answer: total - red
                    };
                },
                () => {
                    const total = random(14, 19);
                    const dogs = random(5, 9);
                    return {
                        question: `The pet store has ${total} pets. ${dogs} of them are dogs. The rest are cats. How many cats are there?`,
                        answer: total - dogs
                    };
                },
                // How many more/fewer problems
                () => {
                    const jake = random(11, 16);
                    const emma = random(5, 9);
                    return {
                        question: `Jake has ${jake} stickers. Emma has ${emma} stickers. How many more stickers does Jake have than Emma?`,
                        answer: jake - emma
                    };
                },
                () => {
                    const park = random(13, 17);
                    const home = random(6, 10);
                    return {
                        question: `There are ${park} ducks at the park and ${home} ducks at home. How many fewer ducks are at home than at the park?`,
                        answer: park - home
                    };
                }
            ];
            
            const problem = problems[random(0, problems.length - 1)]();
            return {
                type: 'word',
                question: problem.question,
                answer: problem.answer,
                inputType: 'number'
            };
        }

        // Generate number line problem
        function generateNumberLine() {
            const direction = random(0, 1) ? 'forward' : 'backward';
            
            if (direction === 'forward') {
                const start = random(0, 8);
                const maxJump = Math.min(5, 15 - start); // Ensure we don't go past 15
                const jump = random(1, maxJump);
                return {
                    type: 'numberLine',
                    question: `Start at ${start} on the number line. Jump ${jump} spaces forward. Where do you land?`,
                    answer: start + jump,
                    inputType: 'number',
                    visualization: {
                        start: start,
                        jump: jump,
                        direction: 'forward',
                        answer: start + jump
                    }
                };
            } else {
                const start = random(5, 15); // Start higher for backward jumps
                const maxJump = Math.min(5, start); // Ensure we don't go below 0
                const jump = random(1, maxJump);
                return {
                    type: 'numberLine',
                    question: `Start at ${start} on the number line. Jump ${jump} spaces backward. Where do you land?`,
                    answer: start - jump,
                    inputType: 'number',
                    visualization: {
                        start: start,
                        jump: jump,
                        direction: 'backward',
                        answer: start - jump
                    }
                };
            }
        }

        // Generate make ten problem
        function generateMakeTen() {
            const first = random(11, 16); // Numbers from 11 to 16
            // Calculate the minimum second number needed to get an answer less than 10
            // For example: if first=13, we need second >= 4 (13-4=9)
            //              if first=16, we need second >= 7 (16-7=9)
            const minSecond = first - 9; // This ensures first - second <= 9
            const maxSecond = first - 1; // This ensures the answer is at least 1
            const second = random(minSecond, Math.min(maxSecond, 9)); // Cap at 9 for reasonable difficulty
            
            return {
                type: 'makeTen',
                question: `Use the make 10 strategy to solve ${first} - ${second}.`,
                answer: first - second,
                inputType: 'number',
                visualization: {
                    first: first,
                    second: second
                }
            };
        }

        // Generate counting by tens problem
        function generateCountingByTens() {
            const start = random(1, 5) * 10; // Start at 10, 20, 30, 40, or 50
            const numSteps = random(4, 6); // 4 to 6 numbers in the pattern
            const pattern = [];
            
            for (let i = 0; i < numSteps; i++) {
                pattern.push(start + (i * 10));
            }
            
            const missingIndex = random(1, numSteps - 2); // Don't pick first or last
            const answer = pattern[missingIndex];
            const displayPattern = [...pattern];
            displayPattern[missingIndex] = '__';
            
            return {
                type: 'counting',
                question: `Fill in the missing number in this pattern:<br><strong>${displayPattern.join(', ')}</strong>`,
                answer: answer,
                inputType: 'number'
            };
        }

        function generateQuestions() {
            questions = [];
            
            // Proportional distribution based on questionCount
            // Base ratios for 20 questions: 2 addition, 2 subtraction, 8 word, 4 number line, 2 make10, 2 counting
            const ratio = questionCount / 20;
            
            const counts = {
                addition: Math.max(1, Math.round(2 * ratio)),
                subtraction: Math.max(1, Math.round(2 * ratio)),
                word: Math.max(2, Math.round(8 * ratio)),
                numberLine: Math.max(1, Math.round(4 * ratio)),
                makeTen: Math.max(1, Math.round(2 * ratio)),
                counting: Math.max(1, Math.round(2 * ratio))
            };
            
            // Adjust to match exact count
            let total = Object.values(counts).reduce((a, b) => a + b, 0);
            if (total > questionCount) {
                // Remove from word problems first as they're most common
                counts.word -= (total - questionCount);
            } else if (total < questionCount) {
                // Add to word problems
                counts.word += (questionCount - total);
            }
            
            for (let i = 0; i < counts.addition; i++) questions.push(generateAddition());
            for (let i = 0; i < counts.subtraction; i++) questions.push(generateSubtraction());
            for (let i = 0; i < counts.word; i++) questions.push(generateWordProblem());
            for (let i = 0; i < counts.numberLine; i++) questions.push(generateNumberLine());
            for (let i = 0; i < counts.makeTen; i++) questions.push(generateMakeTen());
            for (let i = 0; i < counts.counting; i++) questions.push(generateCountingByTens());
            
            // Shuffle the questions
            questions = shuffle(questions);
        }

        // Display current question
        function displayQuestion() {
            // Reset canvas handlers flag for new question
            canvasHandlersAttached = false;
            
            const question = questions[currentQuestion];
            document.getElementById('questionNumber').textContent = `Question ${currentQuestion + 1}`;
            document.getElementById('questionText').innerHTML = question.question;
            
            const answerArea = document.getElementById('answerArea');
            answerArea.innerHTML = '';
            
            if (question.inputType === 'number') {
                // Create main wrapper for side-by-side layout
                let contentHTML = '<div class="question-content-wrapper">';
                
                // Left side - question content
                contentHTML += '<div class="question-main">';
                
                // Add visualization if needed
                if (question.type === 'numberLine' && question.visualization) {
                    const viz = question.visualization;
                    contentHTML += '<div class="number-line"><div class="number-line-line"></div>';
                    
                    const minToShow = Math.max(0, Math.min(viz.start, viz.answer) - 2);
                    const maxToShow = Math.min(20, Math.max(viz.start, viz.answer) + 2);
                    
                    for (let i = minToShow; i <= maxToShow; i++) {
                        contentHTML += `
                            <div class="number-line-item">
                                <div class="number-line-tick"></div>
                                <div class="number-line-number">${i}</div>
                            </div>
                        `;
                    }
                    contentHTML += '</div>';
                }
                
                if (question.type === 'makeTen' && question.visualization) {
                    const viz = question.visualization;
                    
                    // Add the 3 blank equations
                    contentHTML += `
                        <div class="make-ten-equations">
                            <div class="equation-line">
                                <span>Step 1:</span>
                                <input type="number" class="equation-blank" placeholder="?">
                                <span>-</span>
                                <input type="number" class="equation-blank" placeholder="?">
                                <span>=</span>
                                <span>10</span>
                            </div>
                            <div class="equation-line">
                                <span>Step 2:</span>
                                <span>10</span>
                                <span>-</span>
                                <input type="number" class="equation-blank" placeholder="?">
                                <span>=</span>
                                <input type="number" class="equation-blank" placeholder="?">
                            </div>
                        </div>
                    `;
                    
                    // Add ten frames with proper alignment
                    contentHTML += '<p style="text-align:center; margin: 10px 0; color: #4a5568; width: 100%;">Use the boxes below to help visualize:</p>';
                    contentHTML += '<div class="make-ten-boxes">';
                    
                    // First ten frame container (pre-filled with 10 dots)
                    contentHTML += '<div class="ten-frame-container">';
                    contentHTML += '<p style="text-align:center; margin: 0 0 5px 0;">First Frame</p>';
                    contentHTML += '<div class="ten-frame" id="frame1">';
                    for (let i = 0; i < 10; i++) {
                        contentHTML += `<div class="ten-frame-dot filled" onclick="toggleDot(this, 1, ${i})"><div class="dot color-pink"></div></div>`;
                    }
                    contentHTML += '</div>';
                    contentHTML += '</div>';
                    
                    // Second ten frame container  
                    contentHTML += '<div class="ten-frame-container">';
                    contentHTML += '<p style="text-align:center; margin: 0 0 5px 0;">Second Frame</p>';
                    contentHTML += '<div class="ten-frame" id="frame2">';
                    for (let i = 0; i < 10; i++) {
                        contentHTML += `<div class="ten-frame-dot" onclick="toggleDot(this, 2, ${i})"></div>`;
                    }
                    contentHTML += '</div>';
                    contentHTML += '</div>';
                    
                    contentHTML += '</div>';
                    
                    contentHTML += '<div style="text-align:center; margin-top:15px; clear: both;"><button onclick="clearFrames()" style="padding: 8px 20px; background: #e2e8f0; border: none; border-radius: 5px; cursor: pointer;">Clear Boxes</button></div>';
                    
                    // Add the Answer line with the main answer input
                    contentHTML += `
                        <div class="make-ten-equations" style="margin-top: 20px;">
                            <div class="equation-line">
                                <span>Answer:</span>
                                <span>${viz.first}</span>
                                <span>-</span>
                                <span>${viz.second}</span>
                                <span>=</span>
                                <input type="number" class="answer-input" id="answerInput" 
                                       placeholder="?" value="${userAnswers[currentQuestion] || ''}"
                                       onkeypress="if(event.key==='Enter') goToNext()" style="width: 80px; margin: 0; font-size: 1.1em; padding: 10px 15px;">
                            </div>
                        </div>
                    `;
                }
                
                // Add answer input (skip for makeTen questions as it's in the Answer line)
                if (question.type !== 'makeTen') {
                    contentHTML += `
                        <input type="number" class="answer-input" id="answerInput" 
                               placeholder="Your answer" value="${userAnswers[currentQuestion] || ''}"
                               onkeypress="if(event.key==='Enter') goToNext()">
                    `;
                }
                
                contentHTML += '</div>'; // Close question-main
                
                // Right side - workspace with drawing canvas only
                contentHTML += `
                    <div class="workspace" id="workspace">
                        <div class="workspace-header">
                            <div class="workspace-title">Draw your work here:</div>
                        </div>
                        <canvas id="drawingCanvas" class="drawing-canvas" width="600" height="600"></canvas>
                        <div class="canvas-controls">
                            <button class="canvas-button" onclick="clearCanvas()">Clear</button>
                            <button class="canvas-button active" id="color-black" onclick="setColor('black')" style="background: black; color: white;">Black</button>
                            <button class="canvas-button" id="color-blue" onclick="setColor('blue')" style="background: blue; color: white;">Blue</button>
                            <button class="canvas-button" id="color-red" onclick="setColor('red')" style="background: red; color: white;">Red</button>
                            <button class="canvas-button" id="color-green" onclick="setColor('green')" style="background: green; color: white;">Green</button>
                        </div>
                    </div>
                `;
                
                contentHTML += '</div>'; // Close question-content-wrapper
                
                answerArea.innerHTML = contentHTML;
                
                // Initialize canvas
                setTimeout(() => initCanvas(), 100);
                
                setTimeout(() => {
                    const input = document.getElementById('answerInput');
                    if (input) input.focus();
                    setupIOSKeyboardHandling();
                }, 100);
                
            } else if (question.inputType === 'multiple') {
                answerArea.innerHTML = '<div class="multiple-choice" id="multipleChoice"></div>';
                const choiceContainer = document.getElementById('multipleChoice');
                
                question.choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.className = 'choice-button';
                    button.textContent = choice;
                    button.onclick = function() {
                        document.querySelectorAll('.choice-button').forEach(b => b.classList.remove('selected'));
                        this.classList.add('selected');
                    };
                    choiceContainer.appendChild(button);
                });
            }
            
            // Update progress bar
            const progress = ((currentQuestion + 1) / questions.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = `${currentQuestion + 1} of ${questions.length}`;
        }
        
        // Save workspace data (canvas only now)
        function saveWorkspaceData() {
            const canvas = document.getElementById('drawingCanvas');
            if (canvas) {
                canvasData[currentQuestion] = canvas.toDataURL();
            }
        }
        
        // Canvas drawing functionality
        let isDrawing = false;
        let drawColor = 'black';
        
        window.setColor = function(color) {
            drawColor = color;
            
            // Remove active class from all color buttons
            document.querySelectorAll('.canvas-button[id^="color-"]').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to selected color button
            const selectedButton = document.getElementById('color-' + color);
            if (selectedButton) {
                selectedButton.classList.add('active');
            }
        };
        
        window.clearCanvas = function() {
            const canvas = document.getElementById('drawingCanvas');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                canvasData[currentQuestion] = null;
            }
        };
        
        // Store canvas event handlers to prevent duplicates
        let canvasHandlersAttached = false;
        
        function initCanvas(skipLoadingSavedData = false) {
            const canvas = document.getElementById('drawingCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Load saved canvas data if exists (skip if we're re-initializing after expand/collapse)
            if (!skipLoadingSavedData && canvasData[currentQuestion]) {
                const img = new Image();
                img.onload = function() {
                    ctx.drawImage(img, 0, 0);
                };
                img.src = canvasData[currentQuestion];
            }
            
            // Only attach event listeners once per question
            if (canvasHandlersAttached) return;
            canvasHandlersAttached = true;
            
            // Get canvas bounding rect for proper coordinate calculation
            const getCanvasCoords = (e) => {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                
                if (e.touches) {
                    return {
                        x: (e.touches[0].clientX - rect.left) * scaleX,
                        y: (e.touches[0].clientY - rect.top) * scaleY
                    };
                } else {
                    return {
                        x: (e.clientX - rect.left) * scaleX,
                        y: (e.clientY - rect.top) * scaleY
                    };
                }
            };
            
            function startDrawing(e) {
                const canvas = document.getElementById('drawingCanvas');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                isDrawing = true;
                const coords = getCanvasCoords(e);
                ctx.beginPath();
                ctx.moveTo(coords.x, coords.y);
            }
            
            function draw(e) {
                if (!isDrawing) return;
                const canvas = document.getElementById('drawingCanvas');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const coords = getCanvasCoords(e);
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.strokeStyle = drawColor;
                ctx.lineTo(coords.x, coords.y);
                ctx.stroke();
            }
            
            function handleTouchStart(e) {
                e.preventDefault();
                const canvas = document.getElementById('drawingCanvas');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const coords = getCanvasCoords(e);
                isDrawing = true;
                ctx.beginPath();
                ctx.moveTo(coords.x, coords.y);
            }
            
            function handleTouchMove(e) {
                e.preventDefault();
                if (!isDrawing) return;
                const canvas = document.getElementById('drawingCanvas');
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const coords = getCanvasCoords(e);
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.strokeStyle = drawColor;
                ctx.lineTo(coords.x, coords.y);
                ctx.stroke();
            }
            
            function handleTouchEnd(e) {
                e.preventDefault();
                stopDrawing();
            }
            
            function stopDrawing() {
                if (isDrawing) {
                    isDrawing = false;
                    const canvas = document.getElementById('drawingCanvas');
                    if (canvas) {
                        canvasData[currentQuestion] = canvas.toDataURL();
                    }
                }
            }
            
            // Prevent scrolling when touching canvas on mobile
            canvas.addEventListener('touchstart', function(e) {
                e.preventDefault();
            }, { passive: false });
            
            canvas.addEventListener('touchmove', function(e) {
                e.preventDefault();
            }, { passive: false });
            
            // Attach event listeners
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', handleTouchEnd, { passive: false });
        }
        
        // Navigation functions
        function goToPrevious() {
            if (currentQuestion > 0) {
                saveCurrentAnswer();
                saveWorkspaceData();
                currentQuestion--;
                displayQuestion();
                updateNavigationButtons();
            }
        }
        
        function goToNext() {
            // Save current answer first
            const question = questions[currentQuestion];
            let userAnswer;
            
            if (question.inputType === 'number') {
                const input = document.getElementById('answerInput');
                if (input && input.value) {
                    userAnswer = parseInt(input.value);
                    if (!isNaN(userAnswer)) {
                        userAnswers[currentQuestion] = userAnswer;
                        
                        // Check if correct (only count once per question)
                        if (!questions[currentQuestion].scored) {
                            if (userAnswer === question.answer || userAnswer == question.answer) {
                                score++;
                            }
                            questions[currentQuestion].scored = true;
                        }
                    }
                }
            } else if (question.inputType === 'multiple') {
                const selected = document.querySelector('.choice-button.selected');
                if (selected) {
                    userAnswer = selected.textContent;
                    userAnswers[currentQuestion] = userAnswer;
                    
                    // Check if correct (only count once per question)
                    if (!questions[currentQuestion].scored) {
                        if (userAnswer === question.answer || userAnswer == question.answer) {
                            score++;
                        }
                        questions[currentQuestion].scored = true;
                    }
                }
            }
            
            // Save workspace data
            saveWorkspaceData();
            
            // Check if this is the last question
            if (currentQuestion === questions.length - 1) {
                // Finish quiz
                showResults();
            } else {
                // Go to next question
                currentQuestion++;
                displayQuestion();
                updateNavigationButtons();
            }
        }
        
        function saveCurrentAnswer() {
            const question = questions[currentQuestion];
            if (question.inputType === 'number') {
                const input = document.getElementById('answerInput');
                if (input && input.value) {
                    userAnswers[currentQuestion] = parseInt(input.value);
                }
            }
        }
        
        function updateNavigationButtons() {
            const prevButton = document.getElementById('prevButton');
            const nextButton = document.getElementById('nextButton');
            
            if (prevButton) prevButton.disabled = currentQuestion === 0;
            
            // Update Next button text based on position
            if (nextButton) {
                if (currentQuestion === questions.length - 1) {
                    nextButton.textContent = 'Finish Quiz ‚Üí';
                } else {
                    nextButton.textContent = 'Next ‚Üí';
                }
                // Never disable the next button - it always works to submit/advance
                nextButton.disabled = false;
            }
        }

        // Generate explanation for answer
        function generateExplanation(question) {
            let explanation = "";
            
            if (question.type === 'basic') {
                if (question.question.includes('+')) {
                    const parts = question.question.split('+');
                    const a = parseInt(parts[0]);
                    const b = parseInt(parts[1]);
                    explanation = `üéØ Start with ${a}. Now count up ${b} more!\n`;
                    explanation += `Use your fingers: ${a}... `;
                    for (let i = 1; i <= b; i++) {
                        explanation += `${a + i}${i < b ? ', ' : ''}`;
                    }
                    explanation += `\n‚ú® The answer is ${question.answer}!`;
                } else if (question.question.includes('-')) {
                    const parts = question.question.split('-');
                    const a = parseInt(parts[0]);
                    const b = parseInt(parts[1]);
                    explanation = `üéØ Start with ${a}. Now take away ${b}!\n`;
                    explanation += `Count backwards: ${a}... `;
                    for (let i = 1; i <= b; i++) {
                        explanation += `${a - i}${i < b ? ', ' : ''}`;
                    }
                    explanation += `\n‚ú® The answer is ${question.answer}!`;
                }
            } else if (question.type === 'word') {
                // Extract numbers from the word problem
                const numbers = question.question.match(/\d+/g).map(Number);
                if (question.question.includes('had some')) {
                    if (question.question.includes('gave') || question.question.includes('ate') || question.question.includes('lost')) {
                        explanation = `ü§î This is tricky! Someone gave away or lost some things.\n`;
                        explanation += `üí° Think backwards! We need to ADD them back!\n`;
                        explanation += `‚ûï Add: ${numbers[0]} + ${numbers[1]} = ${question.answer}\n`;
                        explanation += `‚ú® They started with ${question.answer}!`;
                    } else {
                        explanation = `ü§î This is tricky! Someone got more things.\n`;
                        explanation += `üí° Think backwards! We need to SUBTRACT what they got!\n`;
                        explanation += `‚ûñ Subtract: ${numbers[1]} - ${numbers[0]} = ${question.answer}\n`;
                        explanation += `‚ú® They started with ${question.answer}!`;
                    }
                } else if (question.question.includes('more than')) {
                    explanation = `üéØ "More than" means ADD!\n`;
                    explanation += `${numbers[0]} + ${numbers[1]} = ${question.answer}\n`;
                    explanation += `‚ú® The answer is ${question.answer}!`;
                } else if (question.question.includes('fewer than')) {
                    explanation = `üéØ "Fewer than" means TAKE AWAY!\n`;
                    explanation += `${numbers[0]} - ${numbers[1]} = ${question.answer}\n`;
                    explanation += `‚ú® The answer is ${question.answer}!`;
                } else if (question.question.includes('How many more')) {
                    explanation = `üéØ Find the difference!\n`;
                    explanation += `Take the bigger number minus the smaller number:\n`;
                    explanation += `${Math.max(...numbers)} - ${Math.min(...numbers)} = ${question.answer}\n`;
                    explanation += `‚ú® The answer is ${question.answer}!`;
                } else {
                    explanation = `üí≠ Read the story carefully!\n`;
                    explanation += `Are things coming together? Then ADD! ‚ûï\n`;
                    explanation += `Are things going away? Then SUBTRACT! ‚ûñ\n`;
                    explanation += `‚ú® The answer is ${question.answer}!`;
                }
            } else if (question.type === 'numberLine') {
                const viz = question.visualization;
                if (viz.direction === 'forward') {
                    explanation = `ü¶ò Let's hop on the number line!\n`;
                    explanation += `Start at ${viz.start}. Make ${viz.jump} hops forward:\n`;
                    for (let i = 0; i <= viz.jump; i++) {
                        explanation += `${viz.start + i}${i < viz.jump ? ' ‚Üí ' : ''}`;
                    }
                    explanation += `\n‚ú® You landed on ${question.answer}!`;
                } else {
                    explanation = `ü¶ò Let's hop backwards on the number line!\n`;
                    explanation += `Start at ${viz.start}. Make ${viz.jump} hops backward:\n`;
                    for (let i = 0; i <= viz.jump; i++) {
                        explanation += `${viz.start - i}${i < viz.jump ? ' ‚Üí ' : ''}`;
                    }
                    explanation += `\n‚ú® You landed on ${question.answer}!`;
                }
            } else if (question.type === 'makeTen') {
                const viz = question.visualization;
                const remainder = viz.first - 10;
                const stepOne = viz.second - remainder;
                explanation = `üåü Make 10 Magic! Let's solve ${viz.first} - ${viz.second}:\n\n`;
                explanation += `Step 1Ô∏è‚É£: Split ${viz.first} into 10 and ${remainder}\n`;
                explanation += `Step 2Ô∏è‚É£: Take ${remainder} away from ${viz.second}: ${viz.second} - ${remainder} = ${stepOne}\n`;
                explanation += `Step 3Ô∏è‚É£: Now take ${stepOne} from 10: 10 - ${stepOne} = ${question.answer}\n\n`;
                explanation += `‚ú® ${viz.first} - ${viz.second} = ${question.answer}!`;
            } else if (question.type === 'counting') {
                explanation = `üî¢ Counting by 10s is easy!\n`;
                const nums = question.question.match(/\d+/g).map(Number).filter(n => !isNaN(n));
                if (nums.length > 0) {
                    explanation += `Each number is 10 bigger than the one before.\n`;
                    explanation += `Start at ${nums[0]}, then add 10, add 10, add 10!\n`;
                    explanation += `‚ú® The missing number is ${question.answer}!`;
                }
            }
            
            return explanation;
        }
        
        // Show results
        function showResults() {
            stopTimer();
            document.getElementById('timerProgressContainer').classList.remove('active');
            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('resultsScreen').style.display = 'block';
            
            // Calculate score based on first attempt only
            score = 0;
            for (let i = 0; i < questions.length; i++) {
                if (userAnswers[i] === questions[i].answer || userAnswers[i] == questions[i].answer) {
                    score++;
                }
            }
            
            const percentage = Math.round((score / questions.length) * 100);
            document.getElementById('scoreDisplay').textContent = `You got ${score} out of ${questions.length} correct!`;
            
            let grade, feedback, title;
            if (percentage >= 90) {
                grade = 'A';
                title = 'Outstanding!';
                feedback = 'Incredible! You\'re a math superstar! üéØ';
            } else if (percentage >= 80) {
                grade = 'B';
                title = 'Great Work!';
                feedback = 'Awesome work! You\'re doing great! üí´';
            } else if (percentage >= 70) {
                grade = 'C';
                title = 'Good Job!';
                feedback = 'Nice job! Keep practicing! üåü';
            } else if (percentage >= 60) {
                grade = 'D';
                title = 'Keep Trying!';
                feedback = 'Good try! You\'re improving! üöÄ';
            } else {
                grade = 'F';
                title = 'Keep Learning!';
                feedback = 'Keep learning! You\'ll get there! üíö';
            }
            
            document.getElementById('resultsTitle').textContent = title;
            document.getElementById('gradeDisplay').textContent = grade;
            document.getElementById('feedback').textContent = feedback;
            
            // Add Practice Again button after feedback
            const feedbackElement = document.getElementById('feedback');
            const buttonHTML = '<button class="restart-button" onclick="restartQuiz()" style="margin: 30px auto;">Practice Again</button>';
            feedbackElement.insertAdjacentHTML('afterend', buttonHTML);
            
            // Add answer review section - display in order (question 1 first)
            let reviewHTML = '<div class="answer-review"><h3 style="text-align: center; margin-bottom: 20px;">Answer Review</h3>';
            
            // Loop through questions in normal order (1 to 20)
            for (let i = 0; i < questions.length; i++) {
                const question = questions[i];
                const userAnswer = userAnswers[i];
                const isCorrect = userAnswer === question.answer || userAnswer == question.answer;
                
                reviewHTML += '<div class="answer-item">';
                reviewHTML += `<div class="answer-question">Question ${i + 1}: ${question.question.replace(/<br>/g, ' ').replace(/<[^>]*>/g, '').replace(/<small>.*?<\/small>/g, '')}</div>`;
                
                if (userAnswer === undefined || userAnswer === null) {
                    reviewHTML += `<div class="user-answer incorrect-answer">‚úó Not answered</div>`;
                    reviewHTML += `<div class="user-answer correct-answer">Correct answer: ${question.answer}</div>`;
                } else if (isCorrect) {
                    reviewHTML += `<div class="user-answer correct-answer">‚úì Your answer: ${userAnswer} (Correct!)</div>`;
                } else {
                    reviewHTML += `<div class="user-answer incorrect-answer">‚úó Your answer: ${userAnswer}</div>`;
                    reviewHTML += `<div class="user-answer correct-answer">Correct answer: ${question.answer}</div>`;
                }
                
                const explanation = generateExplanation(question);
                reviewHTML += `<div class="answer-explanation"><strong>How to solve:</strong><br>${explanation.replace(/\n/g, '<br>')}</div>`;
                reviewHTML += '</div>';
            }
            
            reviewHTML += '</div>';
            
            // Insert the review section after the button
            const resultsScreen = document.getElementById('resultsScreen');
            resultsScreen.insertAdjacentHTML('beforeend', reviewHTML);
        }

        // Start quiz
        function startQuiz() {
            currentQuestion = 0;
            score = 0;
            userAnswers = [];
            canvasData = [];
            generateQuestions();
            
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('quizContainer').style.display = 'block';
            document.getElementById('resultsScreen').style.display = 'none';
            
            // Start timer if enabled
            if (timerEnabled) {
                startTimer();
                document.getElementById('timerProgressContainer').classList.add('active');
            }
            
            displayQuestion();
            updateNavigationButtons();
        }

        // Restart quiz
        function restartQuiz() {
            stopTimer();
            document.getElementById('timerProgressContainer').classList.remove('active');
            
            // Clear any dynamically added content (button and review)
            const resultsScreen = document.getElementById('resultsScreen');
            const feedback = document.getElementById('feedback');
            // Remove everything after feedback (button and review)
            while (feedback.nextSibling) {
                feedback.nextSibling.remove();
            }
            
            document.getElementById('startScreen').style.display = 'block';
            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('resultsScreen').style.display = 'none';
        }
    </script>
</body>
</html>
