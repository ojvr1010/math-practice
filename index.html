<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Math Practice">
    <meta name="format-detection" content="telephone=no">
    <title>1st Grade Math Practice - California Standards</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Comic Sans MS', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            overscroll-behavior: none;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            color: #5a67d8;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        .start-screen {
            text-align: center;
            padding: 40px;
        }
        
        .start-button {
            background: linear-gradient(45deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            padding: 20px 50px;
            font-size: 24px;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.3s;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            -webkit-appearance: none;
            -webkit-tap-highlight-color: transparent;
            min-height: 44px;
            min-width: 44px;
        }
        
        .start-button:hover, .start-button:active {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
        }
        
        .quiz-container {
            display: none;
        }
        
        .progress-bar {
            background: #e2e8f0;
            height: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: linear-gradient(45deg, #43e97b 0%, #38f9d7 100%);
            height: 100%;
            width: 0%;
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .question-card {
            background: #f7fafc;
            border: 3px solid #e2e8f0;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            min-height: 250px;
        }
        
        .question-content-wrapper {
            display: flex;
            gap: 20px;
        }
        
        .question-main {
            flex: 1;
            min-width: 0;
            max-width: 45%;
            overflow-x: auto;
        }
        
        .workspace {
            background: #fef9e7;
            border: 2px dashed #f4d03f;
            border-radius: 10px;
            padding: 15px;
            width: 55%;
            min-height: 450px;
        }
        
        .workspace-fullwidth {
            width: 100%;
            margin: 20px 0;
        }
        
        .question-number {
            color: #5a67d8;
            font-size: 18px;
            margin-bottom: 15px;
            font-weight: bold;
        }
        
        .question-text {
            font-size: 22px;
            color: #2d3748;
            margin-bottom: 25px;
            line-height: 1.6;
        }
        
        .answer-input {
            font-size: 24px;
            padding: 15px;
            border: 3px solid #cbd5e0;
            border-radius: 10px;
            width: 200px;
            text-align: center;
            margin-right: 15px;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .answer-input:focus {
            outline: none;
            border-color: #5a67d8;
        }
        
        .submit-button {
            background: #5a67d8;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s;
            -webkit-appearance: none;
            -webkit-tap-highlight-color: transparent;
            min-height: 44px;
        }
        
        .submit-button:hover, .submit-button:active {
            background: #4c51bf;
        }
        
        .submit-button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }
        
        .number-line {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 30px 0;
            position: relative;
        }
        
        .number-line-item {
            position: relative;
            width: 50px;
            text-align: center;
        }
        
        .number-line-tick {
            width: 2px;
            height: 20px;
            background: #4a5568;
            margin: 0 auto;
        }
        
        .number-line-number {
            margin-top: 10px;
            font-size: 18px;
            color: #2d3748;
        }
        
        .number-line-line {
            position: absolute;
            top: 10px;
            left: 0;
            right: 0;
            height: 2px;
            background: #4a5568;
            z-index: -1;
        }
        
        .make-ten-boxes {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
            flex-wrap: wrap;
        }
        
        .ten-frame-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 230px;
        }
        
        .ten-frame {
            border: 2px solid #4a5568;
            display: inline-grid;
            grid-template-columns: repeat(5, 40px);
            grid-template-rows: repeat(2, 40px);
            gap: 2px;
            background: white;
            padding: 5px;
            box-sizing: content-box;
        }
        
        .ten-frame-dot {
            border: 1px solid #cbd5e0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: white;
            transition: background 0.2s;
        }
        
        .ten-frame-dot:hover {
            background: #f7fafc;
        }
        
        .ten-frame-dot.filled .dot {
            animation: popIn 0.2s ease-out;
        }
        
        @keyframes popIn {
            0% {
                transform: scale(0);
            }
            80% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
            }
        }
        
        .workspace {
            background: #fef9e7;
            border: 2px dashed #f4d03f;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            min-height: 150px;
        }
        
        .workspace-title {
            color: #7a7a7a;
            font-size: 14px;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .workspace-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .mode-button {
            padding: 8px 15px;
            border: 2px solid #f4d03f;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            -webkit-appearance: none;
            -webkit-tap-highlight-color: transparent;
            min-height: 44px;
        }
        
        .mode-button.active {
            background: #f4d03f;
            color: white;
        }
        
        .workspace-area {
            width: 100%;
            min-height: 350px;
            border: none;
            background: transparent;
            font-size: 18px;
            font-family: 'Comic Sans MS', 'Arial', sans-serif;
            resize: none;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .drawing-canvas {
            border: 1px solid #e2e8f0;
            border-radius: 5px;
            cursor: crosshair;
            display: block;
            background: white;
            touch-action: none;
            width: 100%;
            height: 380px;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .canvas-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }
        
        .canvas-button {
            padding: 5px 10px;
            border: 1px solid #cbd5e0;
            background: white;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
            -webkit-appearance: none;
            -webkit-tap-highlight-color: transparent;
            min-height: 36px;
        }
        
        .canvas-button:hover, .canvas-button:active {
            background: #f7fafc;
        }
        
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .nav-button {
            padding: 10px 20px;
            background: #e2e8f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
            -webkit-appearance: none;
            -webkit-tap-highlight-color: transparent;
            min-height: 44px;
        }
        
        .nav-button:hover:not(:disabled), .nav-button:active:not(:disabled) {
            background: #cbd5e0;
        }
        
        .nav-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .make-ten-equations {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
            align-items: center;
        }
        
        .equation-line {
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 24px;
        }
        
        .equation-blank {
            width: 60px;
            height: 40px;
            border: 2px solid #cbd5e0;
            border-radius: 5px;
            text-align: center;
            font-size: 20px;
            -webkit-appearance: none;
            appearance: none;
        }
        
        .answer-review {
            margin: 20px 0;
            padding: 20px;
            background: #f0f9ff;
            border: 2px solid #3182ce;
            border-radius: 10px;
        }
        
        .answer-item {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #cbd5e0;
        }
        
        .answer-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .answer-question {
            font-size: 18px;
            color: #2d3748;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .user-answer {
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .correct-answer {
            color: #48bb78;
        }
        
        .incorrect-answer {
            color: #f56565;
        }
        
        .answer-explanation {
            background: #edf2f7;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 16px;
            color: #4a5568;
        }
        
        .dot {
            width: 25px;
            height: 25px;
            background: #4299e1;
            border-radius: 50%;
        }
        
        .results-screen {
            display: none;
            text-align: center;
            padding: 40px;
        }
        
        .score-display {
            font-size: 28px;
            color: #2d3748;
            margin: 20px 0;
        }
        
        .grade-display {
            font-size: 80px;
            margin: 30px 0;
        }
        
        .feedback {
            font-size: 24px;
            color: #4a5568;
            margin-bottom: 30px;
        }
        
        .restart-button {
            background: linear-gradient(45deg, #43e97b 0%, #38f9d7 100%);
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 20px;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.3s;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            -webkit-appearance: none;
            -webkit-tap-highlight-color: transparent;
            min-height: 44px;
        }
        
        .restart-button:hover, .restart-button:active {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
        }
        
        .choice-button {
            display: block;
            width: 100%;
            padding: 20px;
            margin: 15px 0;
            background: white;
            border: 3px solid #cbd5e0;
            border-radius: 15px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            -webkit-appearance: none;
            -webkit-tap-highlight-color: transparent;
            min-height: 44px;
        }
        
        .choice-button:hover, .choice-button:active {
            background: #f7fafc;
            transform: translateX(5px);
        }
        
        .choice-button.selected {
            background: #c3dafe;
            border-color: #5a67d8;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 1.8em;
            }
            
            .question-content-wrapper {
                flex-direction: column;
            }
            
            .question-main, .workspace {
                width: 100%;
                max-width: 100%;
            }
            
            .question-text {
                font-size: 18px;
            }
            
            .answer-input {
                width: 100%;
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .equation-blank {
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            .workspace-area {
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåü 1st Grade Math Practice üåü</h1>
        
        <div class="start-screen" id="startScreen">
            <h2>Welcome to Math Practice!</h2>
            <p style="font-size: 20px; margin: 20px 0; color: #4a5568;">
                Get ready for 20 fun math questions!<br>
                You'll see different types of problems just like in class.
            </p>
            <button class="start-button" onclick="startQuiz()">Start Practice!</button>
        </div>
        
        <div class="quiz-container" id="quizContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar">
                    <span id="progressText">1 of 20</span>
                </div>
            </div>
            
            <div class="question-card">
                <div class="question-number" id="questionNumber">Question 1</div>
                <div class="question-text" id="questionText"></div>
                <div id="answerArea"></div>
            </div>
            
            <button class="submit-button" id="submitButton" onclick="submitAnswer()">Submit Answer</button>
            
            <div class="navigation-buttons">
                <button class="nav-button" id="prevButton" onclick="goToPrevious()">‚Üê Previous</button>
                <button class="nav-button" id="nextButton" onclick="goToNext()">Next ‚Üí</button>
            </div>
        </div>
        
        <div class="results-screen" id="resultsScreen">
            <h2>Great Job! You Finished!</h2>
            <div class="score-display" id="scoreDisplay"></div>
            <div class="grade-display" id="gradeDisplay"></div>
            <div class="feedback" id="feedback"></div>
            <button class="restart-button" onclick="restartQuiz()">Try Again!</button>
        </div>
    </div>

    <script>
        let currentQuestion = 0;
        let score = 0;
        let questions = [];
        let userAnswers = [];
        let workspaceData = []; // Store workspace content for each question
        let workspaceMode = []; // Store mode (write/draw) for each question
        let canvasData = []; // Store canvas drawings for each question

        // Initialize ten frame functions globally
        window.toggleDot = function(element, frame, index) {
            if (element.innerHTML) {
                element.innerHTML = '';
                element.classList.remove('filled');
            } else {
                element.innerHTML = '<div class="dot"></div>';
                element.classList.add('filled');
            }
        };
        
        window.clearFrames = function() {
            document.querySelectorAll('.ten-frame-dot').forEach(dot => {
                dot.innerHTML = '';
                dot.classList.remove('filled');
            });
        };

        // iOS keyboard handling - scroll input into view
        function setupIOSKeyboardHandling() {
            const inputs = document.querySelectorAll('input[type="number"], textarea');
            inputs.forEach(input => {
                input.addEventListener('focus', function() {
                    setTimeout(() => {
                        this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                });
            });
        }

        // Generate random number within range
        function random(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // Shuffle array
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Generate addition problem (sum up to 20)
        function generateAddition() {
            const a = random(0, 10);
            const b = random(0, 10);
            return {
                type: 'basic',
                question: `${a} + ${b} = ?`,
                answer: a + b,
                inputType: 'number'
            };
        }

        // Generate subtraction problem (within 20)
        function generateSubtraction() {
            const a = random(10, 20);
            const b = random(0, a);
            return {
                type: 'basic',
                question: `${a} - ${b} = ?`,
                answer: a - b,
                inputType: 'number'
            };
        }

        // Generate word problem
        function generateWordProblem() {
            const problems = [
                // Unknown starting value problems
                () => {
                    const gave = random(3, 7);
                    const left = random(8, 15);
                    return {
                        question: `Emily had some apples. She gave ${gave} apples to David. Now Emily has ${left} apples. How many apples did Emily have at first?`,
                        answer: gave + left
                    };
                },
                () => {
                    const found = random(4, 8);
                    const total = random(12, 18);
                    return {
                        question: `Jack had some marbles. He found ${found} more marbles. Now he has ${total} marbles. How many marbles did Jack have before?`,
                        answer: total - found
                    };
                },
                () => {
                    const ate = random(3, 6);
                    const left = random(7, 14);
                    return {
                        question: `Mom had some cookies. The family ate ${ate} cookies. There are ${left} cookies left. How many cookies did Mom have at first?`,
                        answer: ate + left
                    };
                },
                () => {
                    const bought = random(5, 9);
                    const total = random(11, 17);
                    return {
                        question: `Sarah had some toy cars. She bought ${bought} more toy cars. Now she has ${total} toy cars. How many toy cars did she start with?`,
                        answer: total - bought
                    };
                },
                // Comparison and difference problems
                () => {
                    const tom = random(4, 9);
                    const more = random(2, 5);
                    return {
                        question: `Tom has ${tom} books. Lisa has ${more} more books than Tom. How many books does Lisa have?`,
                        answer: tom + more
                    };
                },
                () => {
                    const anna = random(10, 15);
                    const fewer = random(3, 6);
                    return {
                        question: `Anna has ${anna} crayons. Ben has ${fewer} fewer crayons than Anna. How many crayons does Ben have?`,
                        answer: anna - fewer
                    };
                },
                // Multi-step problems
                () => {
                    const morning = random(3, 6);
                    const afternoon = random(4, 7);
                    const gave = random(2, 4);
                    const total = morning + afternoon - gave;
                    return {
                        question: `Lily picked ${morning} flowers in the morning and ${afternoon} flowers in the afternoon. She gave ${gave} flowers to her mom. How many flowers does Lily have now?`,
                        answer: total
                    };
                },
                () => {
                    const had = random(8, 12);
                    const bought = random(3, 6);
                    const lost = random(2, 4);
                    return {
                        question: `Alex had ${had} pencils. He bought ${bought} more pencils, then lost ${lost} pencils. How many pencils does Alex have now?`,
                        answer: had + bought - lost
                    };
                },
                // Missing part problems
                () => {
                    const total = random(12, 18);
                    const red = random(4, 8);
                    return {
                        question: `There are ${total} birds in total. ${red} birds are red. The rest are blue. How many birds are blue?`,
                        answer: total - red
                    };
                },
                () => {
                    const total = random(14, 19);
                    const dogs = random(5, 9);
                    return {
                        question: `The pet store has ${total} pets. ${dogs} of them are dogs. The rest are cats. How many cats are there?`,
                        answer: total - dogs
                    };
                },
                // How many more/fewer problems
                () => {
                    const jake = random(11, 16);
                    const emma = random(5, 9);
                    return {
                        question: `Jake has ${jake} stickers. Emma has ${emma} stickers. How many more stickers does Jake have than Emma?`,
                        answer: jake - emma
                    };
                },
                () => {
                    const park = random(13, 17);
                    const home = random(6, 10);
                    return {
                        question: `There are ${park} ducks at the park and ${home} ducks at home. How many fewer ducks are at home than at the park?`,
                        answer: park - home
                    };
                }
            ];
            
            const problem = problems[random(0, problems.length - 1)]();
            return {
                type: 'word',
                question: problem.question,
                answer: problem.answer,
                inputType: 'number'
            };
        }

        // Generate number line problem
        function generateNumberLine() {
            const direction = random(0, 1) ? 'forward' : 'backward';
            
            if (direction === 'forward') {
                const start = random(0, 8);
                const maxJump = Math.min(5, 15 - start); // Ensure we don't go past 15
                const jump = random(1, maxJump);
                return {
                    type: 'numberLine',
                    question: `Start at ${start} on the number line. Jump ${jump} spaces forward. Where do you land?`,
                    answer: start + jump,
                    inputType: 'number',
                    visualization: {
                        start: start,
                        jump: jump,
                        direction: 'forward',
                        answer: start + jump
                    }
                };
            } else {
                const start = random(5, 15); // Start higher for backward jumps
                const maxJump = Math.min(5, start); // Ensure we don't go below 0
                const jump = random(1, maxJump);
                return {
                    type: 'numberLine',
                    question: `Start at ${start} on the number line. Jump ${jump} spaces backward. Where do you land?`,
                    answer: start - jump,
                    inputType: 'number',
                    visualization: {
                        start: start,
                        jump: jump,
                        direction: 'backward',
                        answer: start - jump
                    }
                };
            }
        }

        // Generate make ten problem
        function generateMakeTen() {
            const first = random(11, 16); // Make sure it's greater than 10
            const second = random(3, 7);
            
            return {
                type: 'makeTen',
                question: `Use the make 10 strategy to solve ${first} - ${second}.<br><small>(Remember: Break ${first} into 10 and some more)</small>`,
                answer: first - second,
                inputType: 'number',
                visualization: {
                    first: first,
                    second: second
                }
            };
        }

        // Generate counting by tens problem
        function generateCountingByTens() {
            const start = random(10, 50);
            const numSteps = random(3, 5);
            const pattern = [];
            
            for (let i = 0; i < numSteps; i++) {
                pattern.push(start + (i * 10));
            }
            
            const missingIndex = random(1, numSteps - 1);
            const answer = pattern[missingIndex];
            const displayPattern = [...pattern];
            displayPattern[missingIndex] = '__';
            
            return {
                type: 'counting',
                question: `Fill in the missing number in this pattern:<br><strong>${displayPattern.join(', ')}</strong>`,
                answer: answer,
                inputType: 'number'
            };
        }

        function generateQuestions() {
            questions = [];
            
            // Adjusted mix: fewer equations, more word problems
            // 2 addition, 2 subtraction, 8 word problems, 4 number line, 
            // 2 make 10, 2 counting by tens
            
            for (let i = 0; i < 2; i++) questions.push(generateAddition());
            for (let i = 0; i < 2; i++) questions.push(generateSubtraction());
            for (let i = 0; i < 8; i++) questions.push(generateWordProblem());
            for (let i = 0; i < 4; i++) questions.push(generateNumberLine());
            for (let i = 0; i < 2; i++) questions.push(generateMakeTen());
            for (let i = 0; i < 2; i++) questions.push(generateCountingByTens());
            
            // Shuffle the questions
            questions = shuffle(questions);
        }

        // Display current question
        function displayQuestion() {
            const question = questions[currentQuestion];
            document.getElementById('questionNumber').textContent = `Question ${currentQuestion + 1}`;
            document.getElementById('questionText').innerHTML = question.question;
            
            const answerArea = document.getElementById('answerArea');
            answerArea.innerHTML = '';
            
            if (question.inputType === 'number') {
                // Create main wrapper for side-by-side layout
                let contentHTML = '<div class="question-content-wrapper">';
                
                // Left side - question content
                contentHTML += '<div class="question-main">';
                
                // Add visualization if needed
                if (question.type === 'numberLine' && question.visualization) {
                    const viz = question.visualization;
                    contentHTML += '<div class="number-line"><div class="number-line-line"></div>';
                    
                    const minToShow = Math.max(0, Math.min(viz.start, viz.answer) - 2);
                    const maxToShow = Math.min(20, Math.max(viz.start, viz.answer) + 2);
                    
                    for (let i = minToShow; i <= maxToShow; i++) {
                        contentHTML += `
                            <div class="number-line-item">
                                <div class="number-line-tick"></div>
                                <div class="number-line-number">${i}</div>
                            </div>
                        `;
                    }
                    contentHTML += '</div>';
                }
                
                if (question.type === 'makeTen' && question.visualization) {
                    const viz = question.visualization;
                    
                    // Add the 3 blank equations
                    contentHTML += `
                        <div class="make-ten-equations">
                            <div class="equation-line">
                                <span>Step 1:</span>
                                <input type="number" class="equation-blank" placeholder="?">
                                <span>-</span>
                                <input type="number" class="equation-blank" placeholder="?">
                                <span>=</span>
                                <span>10</span>
                            </div>
                            <div class="equation-line">
                                <span>Step 2:</span>
                                <span>10</span>
                                <span>-</span>
                                <input type="number" class="equation-blank" placeholder="?">
                                <span>=</span>
                                <input type="number" class="equation-blank" placeholder="?">
                            </div>
                            <div class="equation-line">
                                <span>Answer:</span>
                                <span>${viz.first}</span>
                                <span>-</span>
                                <span>${viz.second}</span>
                                <span>=</span>
                                <input type="number" class="equation-blank" placeholder="?" style="background: #e6fffa;">
                            </div>
                        </div>
                    `;
                    
                    // Add ten frames with proper alignment
                    contentHTML += '<p style="text-align:center; margin: 10px 0; color: #4a5568; width: 100%;">Use the boxes below to help visualize:</p>';
                    contentHTML += '<div class="make-ten-boxes">';
                    
                    // First ten frame container
                    contentHTML += '<div class="ten-frame-container">';
                    contentHTML += '<p style="text-align:center; margin: 0 0 5px 0;">First Frame</p>';
                    contentHTML += '<div class="ten-frame" id="frame1">';
                    for (let i = 0; i < 10; i++) {
                        contentHTML += `<div class="ten-frame-dot" onclick="toggleDot(this, 1, ${i})"></div>`;
                    }
                    contentHTML += '</div>';
                    contentHTML += '</div>';
                    
                    // Second ten frame container  
                    contentHTML += '<div class="ten-frame-container">';
                    contentHTML += '<p style="text-align:center; margin: 0 0 5px 0;">Second Frame</p>';
                    contentHTML += '<div class="ten-frame" id="frame2">';
                    for (let i = 0; i < 10; i++) {
                        contentHTML += `<div class="ten-frame-dot" onclick="toggleDot(this, 2, ${i})"></div>`;
                    }
                    contentHTML += '</div>';
                    contentHTML += '</div>';
                    
                    contentHTML += '</div>';
                    
                    contentHTML += '<div style="text-align:center; margin-top:15px; clear: both;"><button onclick="clearFrames()" style="padding: 8px 20px; background: #e2e8f0; border: none; border-radius: 5px; cursor: pointer;">Clear Boxes</button></div>';
                }
                
                // Add answer input
                contentHTML += `
                    <div style="margin-top: 20px;">
                        <input type="number" class="answer-input" id="answerInput" 
                               placeholder="Your answer" value="${userAnswers[currentQuestion] || ''}"
                               onkeypress="if(event.key==='Enter') submitAnswer()">
                    </div>
                `;
                
                contentHTML += '</div>'; // Close question-main
                
                // Right side - workspace
                contentHTML += `
                    <div class="workspace">
                        <div class="workspace-title">Show your work here (optional):</div>
                        <div class="workspace-controls">
                            <button class="mode-button ${(!workspaceMode[currentQuestion] || workspaceMode[currentQuestion] === 'write') ? 'active' : ''}" onclick="setWorkspaceMode('write')">‚úèÔ∏è Write</button>
                            <button class="mode-button ${workspaceMode[currentQuestion] === 'draw' ? 'active' : ''}" onclick="setWorkspaceMode('draw')">üé® Draw</button>
                        </div>
                        <div id="workspaceContent">
                            ${(!workspaceMode[currentQuestion] || workspaceMode[currentQuestion] === 'write') ? 
                                `<textarea class="workspace-area" id="workspace" placeholder="You can write your work here...">${workspaceData[currentQuestion] || ''}</textarea>` :
                                `<canvas id="drawingCanvas" class="drawing-canvas" width="480" height="380"></canvas>
                                <div class="canvas-controls">
                                    <button class="canvas-button" onclick="clearCanvas()">Clear</button>
                                    <button class="canvas-button" onclick="setColor('black')" style="background: black; color: white;">Black</button>
                                    <button class="canvas-button" onclick="setColor('blue')" style="background: blue; color: white;">Blue</button>
                                    <button class="canvas-button" onclick="setColor('red')" style="background: red; color: white;">Red</button>
                                    <button class="canvas-button" onclick="setColor('green')" style="background: green; color: white;">Green</button>
                                </div>`}
                        </div>
                    </div>
                `;
                
                contentHTML += '</div>'; // Close question-content-wrapper
                
                answerArea.innerHTML = contentHTML;
                
                // Initialize canvas if in draw mode
                if (workspaceMode[currentQuestion] === 'draw') {
                    setTimeout(() => initCanvas(), 100);
                }
                
                setTimeout(() => {
                    const input = document.getElementById('answerInput');
                    if (input) input.focus();
                    setupIOSKeyboardHandling();
                }, 100);
                
            } else if (question.inputType === 'multiple') {
                answerArea.innerHTML = '<div class="multiple-choice" id="multipleChoice"></div>';
                const choiceContainer = document.getElementById('multipleChoice');
                
                question.choices.forEach(choice => {
                    const button = document.createElement('button');
                    button.className = 'choice-button';
                    button.textContent = choice;
                    button.onclick = function() {
                        document.querySelectorAll('.choice-button').forEach(b => b.classList.remove('selected'));
                        this.classList.add('selected');
                    };
                    choiceContainer.appendChild(button);
                });
            }
            
            // Update progress bar
            const progress = ((currentQuestion + 1) / questions.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = `${currentQuestion + 1} of ${questions.length}`;
        }
        
        // Helper function to create element from HTML string
        function createElementFromHTML(htmlString) {
            const div = document.createElement('div');
            div.innerHTML = htmlString.trim();
            return div.firstChild;
        }
        
        // Workspace mode management
        window.setWorkspaceMode = function(mode) {
            saveWorkspaceData(); // Save current data before switching
            workspaceMode[currentQuestion] = mode;
            displayQuestion(); // Redraw with new mode
            
            if (mode === 'draw') {
                setTimeout(() => initCanvas(), 100);
            }
        };
        
        // Save workspace data
        function saveWorkspaceData() {
            if (!workspaceMode[currentQuestion] || workspaceMode[currentQuestion] === 'write') {
                const workspace = document.getElementById('workspace');
                if (workspace) {
                    workspaceData[currentQuestion] = workspace.value;
                }
            } else if (workspaceMode[currentQuestion] === 'draw') {
                const canvas = document.getElementById('drawingCanvas');
                if (canvas) {
                    canvasData[currentQuestion] = canvas.toDataURL();
                }
            }
        }
        
        // Canvas drawing functionality
        let isDrawing = false;
        let drawColor = 'black';
        
        window.setColor = function(color) {
            drawColor = color;
        };
        
        window.clearCanvas = function() {
            const canvas = document.getElementById('drawingCanvas');
            if (canvas) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                canvasData[currentQuestion] = null;
            }
        };
        
        function initCanvas() {
            const canvas = document.getElementById('drawingCanvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            
            // Load saved canvas data if exists
            if (canvasData[currentQuestion]) {
                const img = new Image();
                img.onload = function() {
                    ctx.drawImage(img, 0, 0);
                };
                img.src = canvasData[currentQuestion];
            }
            
            // Get canvas bounding rect for proper coordinate calculation
            const getCanvasCoords = (e) => {
                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;
                
                if (e.touches) {
                    return {
                        x: (e.touches[0].clientX - rect.left) * scaleX,
                        y: (e.touches[0].clientY - rect.top) * scaleY
                    };
                } else {
                    return {
                        x: (e.clientX - rect.left) * scaleX,
                        y: (e.clientY - rect.top) * scaleY
                    };
                }
            };
            
            // Prevent scrolling when touching canvas on mobile
            canvas.addEventListener('touchstart', function(e) {
                e.preventDefault();
            }, { passive: false });
            
            canvas.addEventListener('touchmove', function(e) {
                e.preventDefault();
            }, { passive: false });
            
            // Mouse events
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // Touch events for tablets and iOS
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', handleTouchEnd, { passive: false });
            
            function startDrawing(e) {
                isDrawing = true;
                const coords = getCanvasCoords(e);
                ctx.beginPath();
                ctx.moveTo(coords.x, coords.y);
            }
            
            function draw(e) {
                if (!isDrawing) return;
                const coords = getCanvasCoords(e);
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.strokeStyle = drawColor;
                ctx.lineTo(coords.x, coords.y);
                ctx.stroke();
            }
            
            function handleTouchStart(e) {
                e.preventDefault();
                const coords = getCanvasCoords(e);
                isDrawing = true;
                ctx.beginPath();
                ctx.moveTo(coords.x, coords.y);
            }
            
            function handleTouchMove(e) {
                e.preventDefault();
                if (!isDrawing) return;
                const coords = getCanvasCoords(e);
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.strokeStyle = drawColor;
                ctx.lineTo(coords.x, coords.y);
                ctx.stroke();
            }
            
            function handleTouchEnd(e) {
                e.preventDefault();
                stopDrawing();
            }
            
            function stopDrawing() {
                if (isDrawing) {
                    isDrawing = false;
                    canvasData[currentQuestion] = canvas.toDataURL();
                }
            }
        }
        
        // Navigation functions
        function goToPrevious() {
            if (currentQuestion > 0) {
                saveCurrentAnswer();
                saveWorkspaceData();
                currentQuestion--;
                displayQuestion();
                updateNavigationButtons();
            }
        }
        
        function goToNext() {
            if (currentQuestion < questions.length - 1) {
                saveCurrentAnswer();
                saveWorkspaceData();
                currentQuestion++;
                displayQuestion();
                updateNavigationButtons();
            }
        }
        
        function saveCurrentAnswer() {
            const question = questions[currentQuestion];
            if (question.inputType === 'number') {
                const input = document.getElementById('answerInput');
                if (input && input.value) {
                    userAnswers[currentQuestion] = parseInt(input.value);
                }
            }
        }
        
        function updateNavigationButtons() {
            const prevButton = document.getElementById('prevButton');
            const nextButton = document.getElementById('nextButton');
            const submitButton = document.getElementById('submitButton');
            
            if (prevButton) prevButton.disabled = currentQuestion === 0;
            if (nextButton) nextButton.disabled = currentQuestion === questions.length - 1;
            
            // Update submit button text
            if (submitButton) {
                if (currentQuestion === questions.length - 1) {
                    submitButton.textContent = 'Finish Quiz';
                } else {
                    submitButton.textContent = 'Submit Answer';
                }
            }
        }

        // Generate explanation for answer
        function generateExplanation(question) {
            let explanation = "";
            
            if (question.type === 'basic') {
                if (question.question.includes('+')) {
                    const parts = question.question.split('+');
                    const a = parseInt(parts[0]);
                    const b = parseInt(parts[1]);
                    explanation = `To solve ${a} + ${b}: Start with ${a} and count up ${b} more. You can use your fingers or objects to count: ${a}... `;
                    for (let i = 1; i <= b; i++) {
                        explanation += `${a + i}${i < b ? ', ' : ''}`;
                    }
                    explanation += `. So ${a} + ${b} = ${question.answer}.`;
                } else if (question.question.includes('-')) {
                    const parts = question.question.split('-');
                    const a = parseInt(parts[0]);
                    const b = parseInt(parts[1]);
                    explanation = `To solve ${a} - ${b}: Start with ${a} and take away ${b}. You can count backwards: ${a}... `;
                    for (let i = 1; i <= b; i++) {
                        explanation += `${a - i}${i < b ? ', ' : ''}`;
                    }
                    explanation += `. So ${a} - ${b} = ${question.answer}.`;
                }
            } else if (question.type === 'word') {
                // Extract numbers from the word problem
                const numbers = question.question.match(/\d+/g).map(Number);
                if (question.question.includes('had some') || question.question.includes('had some')) {
                    explanation = `This is a "work backwards" problem. `;
                    if (question.question.includes('gave') || question.question.includes('ate') || question.question.includes('lost')) {
                        explanation += `If someone gave away/lost some and has ${numbers[numbers.length-1]} left, add what was given/lost to find the start: ${numbers[0]} + ${numbers[1]} = ${question.answer}.`;
                    } else {
                        explanation += `If someone got more and now has a total, subtract what was added to find the start: ${numbers[1]} - ${numbers[0]} = ${question.answer}.`;
                    }
                } else if (question.question.includes('more than')) {
                    explanation = `"More than" means add. If someone has ${numbers[1]} more than ${numbers[0]}, calculate: ${numbers[0]} + ${numbers[1]} = ${question.answer}.`;
                } else if (question.question.includes('fewer than')) {
                    explanation = `"Fewer than" means subtract. If someone has ${numbers[1]} fewer than ${numbers[0]}, calculate: ${numbers[0]} - ${numbers[1]} = ${question.answer}.`;
                } else if (question.question.includes('How many more')) {
                    explanation = `To find "how many more," subtract the smaller from the larger: ${Math.max(...numbers)} - ${Math.min(...numbers)} = ${question.answer}.`;
                } else {
                    explanation = `Read carefully to see if you need to add (combine/total) or subtract (take away/left). The answer is ${question.answer}.`;
                }
            } else if (question.type === 'numberLine') {
                const viz = question.visualization;
                if (viz.direction === 'forward') {
                    explanation = `Start at ${viz.start} on the number line. Jump ${viz.jump} spaces forward: `;
                    for (let i = 0; i <= viz.jump; i++) {
                        explanation += `${viz.start + i}${i < viz.jump ? ' ‚Üí ' : ''}`;
                    }
                    explanation += `. You land on ${question.answer}.`;
                } else {
                    explanation = `Start at ${viz.start} on the number line. Jump ${viz.jump} spaces backward: `;
                    for (let i = 0; i <= viz.jump; i++) {
                        explanation += `${viz.start - i}${i < viz.jump ? ' ‚Üí ' : ''}`;
                    }
                    explanation += `. You land on ${question.answer}.`;
                }
            } else if (question.type === 'makeTen') {
                const viz = question.visualization;
                const remainder = viz.first - 10;
                const stepOne = viz.second - remainder;
                explanation = `Make 10 Strategy for ${viz.first} - ${viz.second}:\n`;
                explanation += `Step 1: Break ${viz.first} into 10 and ${remainder}.\n`;
                explanation += `Step 2: First subtract ${remainder} from ${viz.second}: ${viz.second} - ${remainder} = ${stepOne}.\n`;
                explanation += `Step 3: Now subtract from 10: 10 - ${stepOne} = ${question.answer}.\n`;
                explanation += `So ${viz.first} - ${viz.second} = ${question.answer}.`;
            } else if (question.type === 'counting') {
                explanation = `When counting by 10s, each number is 10 more than the previous one. `;
                const nums = question.question.match(/\d+/g).map(Number).filter(n => !isNaN(n));
                if (nums.length > 0) {
                    explanation += `The pattern starts at ${nums[0]} and adds 10 each time. The missing number is ${question.answer}.`;
                }
            }
            
            return explanation;
        }
        
        // Submit answer
        function submitAnswer() {
            const question = questions[currentQuestion];
            let userAnswer;
            
            if (question.inputType === 'number') {
                const input = document.getElementById('answerInput');
                userAnswer = parseInt(input.value);
                if (isNaN(userAnswer)) {
                    alert('Please enter a number!');
                    return;
                }
            } else if (question.inputType === 'multiple') {
                const selected = document.querySelector('.choice-button.selected');
                if (!selected) {
                    alert('Please select an answer!');
                    return;
                }
                userAnswer = selected.textContent;
            }
            
            // Save answer and workspace
            userAnswers[currentQuestion] = userAnswer;
            saveWorkspaceData();
            
            // Check if correct (only count once per question)
            if (!questions[currentQuestion].scored) {
                if (userAnswer === question.answer || userAnswer == question.answer) {
                    score++;
                }
                questions[currentQuestion].scored = true;
            }
            
            currentQuestion++;
            
            if (currentQuestion < questions.length) {
                displayQuestion();
                updateNavigationButtons();
            } else {
                showResults();
            }
        }

        // Show results
        function showResults() {
            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('resultsScreen').style.display = 'block';
            
            // Calculate score based on first attempt only
            score = 0;
            for (let i = 0; i < questions.length; i++) {
                if (userAnswers[i] === questions[i].answer || userAnswers[i] == questions[i].answer) {
                    score++;
                }
            }
            
            const percentage = Math.round((score / questions.length) * 100);
            document.getElementById('scoreDisplay').textContent = `You got ${score} out of ${questions.length} correct!`;
            
            let grade, emoji, feedback;
            if (percentage >= 90) {
                grade = 'A';
                emoji = 'üåü';
                feedback = 'Outstanding work! You\'re a math star!';
            } else if (percentage >= 80) {
                grade = 'B';
                emoji = 'üòä';
                feedback = 'Great job! Keep up the good work!';
            } else if (percentage >= 70) {
                grade = 'C';
                emoji = 'üëç';
                feedback = 'Good effort! Practice makes perfect!';
            } else if (percentage >= 60) {
                grade = 'D';
                emoji = 'üí™';
                feedback = 'Keep trying! You\'re getting there!';
            } else {
                grade = 'F';
                emoji = 'ü§ó';
                feedback = 'Don\'t give up! Let\'s try again!';
            }
            
            document.getElementById('gradeDisplay').innerHTML = `${emoji} ${grade} ${emoji}`;
            document.getElementById('feedback').textContent = feedback;
            
            // Add answer review section - display in REVERSE order (newest first)
            let reviewHTML = '<div class="answer-review"><h3 style="text-align: center; color: #5a67d8; margin-bottom: 20px;">üìö Answer Review üìö</h3>';
            reviewHTML += '<p style="text-align: center; color: #7a7a7a; margin-bottom: 15px;">(Showing most recent questions first)</p>';
            
            // Loop through questions in REVERSE order
            for (let i = questions.length - 1; i >= 0; i--) {
                const question = questions[i];
                const userAnswer = userAnswers[i];
                const isCorrect = userAnswer === question.answer || userAnswer == question.answer;
                
                reviewHTML += '<div class="answer-item">';
                reviewHTML += `<div class="answer-question">Question ${i + 1}: ${question.question.replace(/<br>/g, ' ').replace(/<[^>]*>/g, '').replace(/<small>.*?<\/small>/g, '')}</div>`;
                
                if (userAnswer === undefined || userAnswer === null) {
                    reviewHTML += `<div class="user-answer incorrect-answer">‚úó Not answered</div>`;
                    reviewHTML += `<div class="user-answer correct-answer">Correct answer: ${question.answer}</div>`;
                } else if (isCorrect) {
                    reviewHTML += `<div class="user-answer correct-answer">‚úì Your answer: ${userAnswer} (Correct!)</div>`;
                } else {
                    reviewHTML += `<div class="user-answer incorrect-answer">‚úó Your answer: ${userAnswer}</div>`;
                    reviewHTML += `<div class="user-answer correct-answer">Correct answer: ${question.answer}</div>`;
                }
                
                const explanation = generateExplanation(question);
                reviewHTML += `<div class="answer-explanation"><strong>How to solve:</strong><br>${explanation.replace(/\n/g, '<br>')}</div>`;
                reviewHTML += '</div>';
            }
            
            reviewHTML += '</div>';
            
            // Insert the review section after the feedback
            const feedbackElement = document.getElementById('feedback');
            feedbackElement.insertAdjacentHTML('afterend', reviewHTML);
        }

        // Start quiz
        function startQuiz() {
            currentQuestion = 0;
            score = 0;
            userAnswers = [];
            workspaceData = [];
            workspaceMode = [];
            canvasData = [];
            generateQuestions();
            
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('quizContainer').style.display = 'block';
            document.getElementById('resultsScreen').style.display = 'none';
            
            displayQuestion();
            updateNavigationButtons();
        }

        // Restart quiz
        function restartQuiz() {
            document.getElementById('startScreen').style.display = 'block';
            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('resultsScreen').style.display = 'none';
        }
    </script>
</body>
</html>
